(function(){window.ShopList=function(){ShopList.options={autoload:true};function ShopList(element,options){if(options==null){options={}}this.options=_.extend(ShopList.options,options);this._el=$(element);this._list=$(".shop-list",this._el);this._mapContainer=$(".js-shop-list-map",this._el);if(this.options.autoload){this.loadList()}}ShopList.prototype.loadList=function(url){if(url==null){url=window.application.getUrl("shopList")}return $.ajax({method:"get",url:url,contentType:"json",success:function(_this){return function(response){var i,index,len,ref,shop;_this._shops=[];ref=response.shops;for(index=i=0,len=ref.length;i<len;index=++i){shop=ref[index];shop.index=index;_this._shops.push(shop)}_this._render();_this._initMap();return $("#size").on("change",function(event){_this._render();return _this._initMap()})}}(this)})};ShopList.prototype._render=function(){var filter_shops,i,len,li,shop,shop_mobile_select,size,template;this._list.children().remove();size=$("#size").val();shop_mobile_select=$("#shop");filter_shops=[];$.each(this._shops,function(_this){return function(j,shop){if($.inArray(size,shop.sizes)!==-1){return filter_shops.push(shop)}}}(this));shop_mobile_select[0].selectize.clearOptions();for(i=0,len=filter_shops.length;i<len;i++){shop=filter_shops[i];template=_.template('<li class="shop-list-item" data-index="<%=index%>">\n  <% if (title) { %>\n    <div class="shop-list-item__title"><%=title%></div>\n  <% } %>\n  <% if (address) { %>\n    <div class="shop-list-item__address"><%=address%></div>\n  <% } %>\n  <% if (distance) { %>\n    <div class="shop-list-item__distance">От центра <%=distance%> км</div>\n  <% } %>\n</li>');li=$(template(shop));this._list.append(li);li.on("click",this._itemClickHandler.bind(this));shop_mobile_select[0].selectize.addOption({value:shop.index,text:shop.title})}shop_mobile_select[0].selectize.refreshOptions();return shop_mobile_select.on("change",function(_this){return function(event){return _this._map.select($(event.currentTarget).val())}}(this))};ShopList.prototype._initMap=function(){var $map,center,filter_shops,size;size=$("#size").val();filter_shops=[];$.each(this._shops,function(_this){return function(j,shop){if($.inArray(size,shop.sizes)!==-1){return filter_shops.push(shop)}}}(this));$map=$(this._mapContainer);center={lat:parseFloat($map.data("lat"))||55.7494733,lng:parseFloat($map.data("lon"))||37.35232};return this._map=new window.GoogleMapView(this._mapContainer,{items:filter_shops,google:{center:center},onSelect:function(_this){return function(index){var item;$("#shop")[0].selectize.setValue(index,true);item=$("li[data-index="+index+"]",_this._list);item.siblings().removeClass("selected");return item.addClass("selected")}}(this)})};ShopList.prototype._itemClickHandler=function(event){var index,item;item=$(event.currentTarget);item.siblings().removeClass("selected");item.addClass("selected");index=item.data("index");return this._map.select(index)};return ShopList}()}).call(this);